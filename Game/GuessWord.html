<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Word Guess Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Optional: Customize Tailwind theme if needed
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Use Inter font
                    },
                }
            }
        }
    </script>
    <style>
        /* Add small custom styles if needed */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block; /* Keep it inline */
            margin-left: 8px; /* Space from button text */
            vertical-align: middle; /* Align with text */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center pt-10 px-4">

    <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Cloud Word Guess Game</h1>

    <div id="login-screen" class="w-full max-w-md bg-white p-6 md:p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Join Game</h2>
        <div class="mb-4">
            <label for="username" class="block text-sm font-medium text-gray-600 mb-1">Username:</label>
            <input type="text" id="username" required
                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="mb-6">
            <label for="game-key" class="block text-sm font-medium text-gray-600 mb-1">Game Key:</label>
            <input type="text" id="game-key" required
                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <button id="login-button"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out flex items-center justify-center">
            Enter Game
            <span id="login-spinner" class="loader hidden ml-2"></span> </button>
        <p id="login-error" class="text-red-600 text-sm mt-4 text-center"></p>
    </div>

    <div id="game-screen" class="w-full max-w-md bg-white p-6 md:p-8 rounded-lg shadow-md mt-8 hidden">
        <h2 class="text-xl font-semibold text-gray-700 mb-2">Welcome, <span id="display-username" class="font-bold"></span>!</h2>
        <p class="text-sm text-gray-500 mb-4">Game Key: <span id="display-game-key" class="font-mono"></span></p>

        <div id="game-info" class="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-md mb-6">
            <p id="waiting-message">Waiting for game to start...</p>
            <p id="word-info" class="hidden">The word has <strong id="word-length" class="text-xl"></strong> letters.</p>
        </div>

        <div id="guess-area" class="mb-6 hidden">
            <label for="guess-input" class="block text-sm font-medium text-gray-600 mb-1">Your Guess:</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="guess-input" placeholder="Enter your guess"
                       class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                <button id="submit-guess"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out flex items-center justify-center">
                    Submit
                     <span id="guess-spinner" class="loader hidden ml-2"></span> </button>
            </div>
            <p id="guess-feedback" class="text-md mt-3 font-medium"></p> <p id="guess-error" class="text-red-600 text-sm mt-2"></p> </div>

        <div id="game-over-message" class="bg-yellow-50 border border-yellow-300 text-yellow-800 p-4 rounded-md text-center hidden">
            <h3 class="text-xl font-bold mb-2">Game Over!</h3>
            <p><strong id="winner-name" class="text-2xl"></strong> guessed the word first!</p>
        </div>
    </div>

    <div id="scoreboard" class="w-full max-w-md bg-white p-6 md:p-8 rounded-lg shadow-md mt-8 hidden">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Scoreboard</h2>
        <ul id="score-list" class="space-y-2">
            <li class="text-gray-500 italic">Loading scores...</li>
        </ul>
        <p id="score-error" class="text-red-600 text-sm mt-4 text-center"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const loginScreen = document.getElementById('login-screen');
            const gameScreen = document.getElementById('game-screen');
            const scoreboardDiv = document.getElementById('scoreboard');

            const usernameInput = document.getElementById('username');
            const gameKeyInput = document.getElementById('game-key');
            const loginButton = document.getElementById('login-button');
            const loginSpinner = document.getElementById('login-spinner');
            const loginError = document.getElementById('login-error');

            const displayUsername = document.getElementById('display-username');
            const displayGameKey = document.getElementById('display-game-key');
            const gameInfo = document.getElementById('game-info');
            const waitingMessage = document.getElementById('waiting-message');
            const wordInfo = document.getElementById('word-info');
            const wordLengthSpan = document.getElementById('word-length');

            const guessArea = document.getElementById('guess-area');
            const guessInput = document.getElementById('guess-input');
            const submitGuessButton = document.getElementById('submit-guess');
            const guessSpinner = document.getElementById('guess-spinner');
            const guessFeedback = document.getElementById('guess-feedback');
            const guessError = document.getElementById('guess-error');

            const gameOverMessage = document.getElementById('game-over-message');
            const winnerNameSpan = document.getElementById('winner-name');

            const scoreList = document.getElementById('score-list');
            const scoreError = document.getElementById('score-error');

            // --- State ---
            let currentUsername = null;
            let currentGameKey = null;
            let currentWordLength = 0;
            let scoreUpdateInterval = null;
            let gameStateCheckInterval = null; // To check if game started/ended
            const SCORE_POLL_INTERVAL_MS = 5000; // Check scores every 5 seconds
            const GAME_STATE_POLL_INTERVAL_MS = 8000; // Check game state every 8 seconds
            const API_BASE_URL = "https://perpule-data.firebaseio.com/game/GuessWord"; // Replace with your actual API base URL if needed (e.g., "https://your-api.com")

            // --- API Endpoints (PLACEHOLDERS - REPLACE WITH YOUR ACTUAL API) ---
            // Define the expected request/response structure in comments
            const API = {
                // POST -> Request: { username: string, gameKey: string }
                // POST <- Response (Success): { success: true, gameState: { wordLength: number, winner: string|null, gameActive: boolean } }
                // POST <- Response (Error): { success: false, message: string }
                login: `${API_BASE_URL}/login`,

                // GET -> Query Params: ?gameKey=YOUR_KEY
                // GET <- Response: { wordLength: number, winner: string|null, gameActive: boolean }
                // OR
                // POST -> Request: { gameKey: string }
                // POST <- Response: { wordLength: number, winner: string|null, gameActive: boolean }
                gameState: `${API_BASE_URL}/gameState`, // Choose GET or POST based on your API design

                // POST -> Request: { username: string, gameKey: string, guess: string }
                // POST <- Response (Success): { correct: boolean, correctLetters: number, correctPositions: number, message?: string, winner?: string|null, gameActive: boolean }
                // POST <- Response (Error): { message: string }
                guess: `${API_BASE_URL}/guess`,

                // GET -> Query Params: ?gameKey=YOUR_KEY
                // GET <- Response: { scores: { [username: string]: number } } // Object mapping username to score
                // OR
                // POST -> Request: { gameKey: string }
                // POST <- Response: { scores: { [username: string]: number } }
                scores: `${API_BASE_URL}/scores` // Choose GET or POST based on your API design
            };

            // --- Utility Functions ---

            /**
             * Displays an error message in a specified element.
             * @param {HTMLElement} element - The DOM element to display the error in.
             * @param {string} message - The error message.
             */
            function displayError(element, message) {
                element.textContent = message;
                element.style.display = message ? 'block' : 'none';
                // For Tailwind, you might add/remove classes instead of using style.display
                // if (message) {
                //     element.classList.remove('hidden');
                // } else {
                //     element.classList.add('hidden');
                // }
            }

            /**
             * Shows or hides a loading spinner.
             * @param {HTMLElement} spinnerElement - The spinner span element.
             * @param {boolean} show - True to show, false to hide.
             */
            function toggleSpinner(spinnerElement, show) {
                 if (show) {
                    spinnerElement.classList.remove('hidden');
                } else {
                    spinnerElement.classList.add('hidden');
                }
            }

            /**
             * Makes an API call using fetch.
             * @param {string} url - The API endpoint URL.
             * @param {object} options - Fetch options (method, headers, body).
             * @returns {Promise<object>} - The parsed JSON response.
             * @throws {Error} - If the request fails or response is not ok.
             */
            async function apiCall(url, options = {}) {
                try {
                    const response = await fetch(url, options);

                    // Try to parse JSON regardless of status code for potential error messages
                    let data;
                    try {
                        data = await response.json();
                    } catch (jsonError) {
                        // Handle cases where the response is not valid JSON (e.g., 500 server error HTML page)
                        if (!response.ok) {
                             throw new Error(`HTTP error ${response.status}: ${response.statusText}. Server did not return valid JSON.`);
                        }
                        // If response was ok but JSON parsing failed (unlikely for well-formed APIs)
                        throw new Error("Failed to parse JSON response from server.");
                    }

                    if (!response.ok) {
                        // Use the message from the JSON error response if available
                        const errorMessage = data?.message || `API request failed with status ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    return data; // Return the parsed JSON data on success

                } catch (networkError) {
                    // Handle network errors (e.g., DNS resolution failure, server unreachable)
                    console.error(`Network error calling ${url}:`, networkError);
                    throw new Error(`Network error: Could not connect to the server. Please check your connection.`);
                }
            }


            // --- Core Game Logic Functions ---

            /**
             * Attempts to log the user into the game.
             */
            async function login() {
                const username = usernameInput.value.trim();
                const gameKey = gameKeyInput.value.trim();

                if (!username || !gameKey) {
                    displayError(loginError, "Username and Game Key are required.");
                    return;
                }

                displayError(loginError, ""); // Clear previous errors
                loginButton.disabled = true;
                toggleSpinner(loginSpinner, true); // Show spinner

                try {
                    // *** API CALL: Login ***
                    const data = await apiCall(API.login, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, gameKey })
                    });

                    // Backend should explicitly confirm success
                    if (!data.success) {
                         // Use the message provided by the backend
                        throw new Error(data.message || "Login failed. Please check your Game Key.");
                    }

                    // --- Login successful ---
                    currentUsername = username;
                    currentGameKey = gameKey;

                    // Update UI
                    displayUsername.textContent = currentUsername;
                    displayGameKey.textContent = currentGameKey;
                    loginScreen.classList.add('hidden'); // Hide login
                    gameScreen.classList.remove('hidden'); // Show game
                    scoreboardDiv.classList.remove('hidden'); // Show scoreboard

                    // Update UI with initial game state from login response
                    // Ensure gameState exists in the response
                    if (data.gameState) {
                        updateGameStateUI(data.gameState);
                    } else {
                        console.warn("Login response did not include initial gameState.");
                        // Fetch game state separately if not included in login
                        await fetchGameState();
                    }


                    // Start polling for scores and game state
                    await fetchScores(); // Initial fetch
                    startScorePolling();
                    startGameStatePolling(); // Start checking game state too

                } catch (error) {
                    console.error("Login error:", error);
                    displayError(loginError, `Login failed: ${error.message}`);
                } finally {
                    loginButton.disabled = false;
                    toggleSpinner(loginSpinner, false); // Hide spinner
                }
            }

             /**
             * Fetches the current game state (word length, winner, active status).
             */
            async function fetchGameState() {
                if (!currentGameKey) return; // Don't fetch if not logged in

                try {
                    // *** API CALL: Get Game State ***
                    // Adjust URL/method based on your API design (GET with query param or POST)
                    const url = `${API.gameState}?gameKey=${encodeURIComponent(currentGameKey)}`; // Example for GET
                    const data = await apiCall(url, { method: 'GET' }); // Adjust method if needed

                    // Update UI based on the fetched state
                    updateGameStateUI(data);

                } catch (error) {
                    console.error("Error fetching game state:", error);
                    // Display a non-intrusive error, maybe near the game info area?
                    // displayError(some_status_element, `Could not update game status: ${error.message}`);
                    // Decide if polling should stop on repeated errors
                }
            }


            /**
             * Updates the Game UI elements based on game state.
             * @param {object} gameState - Object like { wordLength: number, winner: string|null, gameActive: boolean }
             */
            function updateGameStateUI(gameState) {
                console.log("Updating Game State UI:", gameState);
                if (!gameState) {
                    console.warn("updateGameStateUI called with null/undefined gameState");
                    return;
                }

                currentWordLength = gameState.wordLength || 0;
                const isGameOver = !!gameState.winner; // Check if there's a winner
                const isGameActive = gameState.gameActive === true; // Explicitly check if active

                // --- Handle Game Over State ---
                if (isGameOver) {
                    wordInfo.classList.add('hidden');
                    guessArea.classList.add('hidden');
                    waitingMessage.classList.add('hidden');
                    gameOverMessage.classList.remove('hidden');
                    winnerNameSpan.textContent = gameState.winner;
                    stopScorePolling(); // Stop polling when game ends
                    stopGameStatePolling(); // Stop checking state too
                    return; // Don't process further if game is over
                }

                // --- Handle Active Game State ---
                if (isGameActive && currentWordLength > 0) {
                    waitingMessage.classList.add('hidden'); // Hide "Waiting..."
                    wordLengthSpan.textContent = currentWordLength;
                    wordInfo.classList.remove('hidden'); // Show word length info
                    guessArea.classList.remove('hidden'); // Show guessing area
                    gameOverMessage.classList.add('hidden'); // Ensure game over message is hidden
                    guessInput.maxLength = currentWordLength; // Set max length for input
                    guessInput.disabled = false;
                    submitGuessButton.disabled = false;
                }
                // --- Handle Inactive/Waiting State ---
                else {
                    waitingMessage.classList.remove('hidden'); // Show "Waiting..."
                    wordInfo.classList.add('hidden');
                    guessArea.classList.add('hidden');
                    gameOverMessage.classList.add('hidden');
                }

                // Clear previous feedback/errors on state update if game is not over
                guessFeedback.textContent = '';
                displayError(guessError, '');
            }


            /**
             * Submits the user's guess to the backend.
             */
            async function submitGuess() {
                const guess = guessInput.value.trim().toLowerCase(); // Standardize guess

                displayError(guessError, ""); // Clear previous errors
                guessFeedback.textContent = "";

                if (!guess) {
                    displayError(guessError, "Please enter a guess.");
                    return;
                }

                if (guess.length !== currentWordLength) {
                    displayError(guessError, `Your guess must be ${currentWordLength} letters long.`);
                    return;
                }

                submitGuessButton.disabled = true;
                guessInput.disabled = true;
                toggleSpinner(guessSpinner, true); // Show spinner

                try {
                    // *** API CALL: Submit Guess ***
                    const data = await apiCall(API.guess, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: currentUsername,
                            gameKey: currentGameKey,
                            guess: guess
                        })
                    });

                    // --- Update UI based on guess response ---
                    if (data.correct) {
                        guessFeedback.textContent = `Congratulations! "${guess.toUpperCase()}" is the correct word!`;
                        guessFeedback.className = 'text-md mt-3 font-medium text-green-600'; // Green for correct
                        // The game state should ideally be updated by the next gameState poll
                        // or the API response could include the final state.
                        if (data.winner) {
                             // Update immediately if winner info is in response
                            updateGameStateUI({ wordLength: currentWordLength, winner: data.winner, gameActive: false });
                        }
                        // Disable further guessing immediately
                        guessInput.disabled = true;
                        submitGuessButton.disabled = true;
                        await fetchScores(); // Fetch scores immediately after correct guess

                    } else {
                        // Provide feedback on correct letters and positions
                        guessFeedback.textContent = `Incorrect. Correct letters: ${data.correctLetters}, Correct positions: ${data.correctPositions}. Try again!`;
                        guessFeedback.className = 'text-md mt-3 font-medium text-yellow-700'; // Orange/Yellow for incorrect
                        guessInput.disabled = false; // Re-enable for next guess
                        guessInput.value = ''; // Clear input field
                        guessInput.focus(); // Set focus back to input
                    }

                    // Update game state based on response if available
                    if (typeof data.gameActive === 'boolean') {
                         updateGameStateUI({
                            wordLength: currentWordLength,
                            winner: data.winner || null, // Use winner from response if present
                            gameActive: data.gameActive
                         });
                    }


                } catch (error) {
                    console.error("Guess submission error:", error);
                    displayError(guessError, `Error: ${error.message}`);
                    guessInput.disabled = false; // Re-enable input on error
                } finally {
                     // Ensure button/spinner are reset unless game is over
                    if (gameOverMessage.classList.contains('hidden')) {
                       submitGuessButton.disabled = false;
                       guessInput.disabled = false; // Make sure input is enabled if guess failed
                    }
                    toggleSpinner(guessSpinner, false); // Hide spinner
                }
            }

            /**
             * Fetches the latest scores from the backend.
             */
            async function fetchScores() {
                if (!currentGameKey) return; // Don't fetch if not logged in

                displayError(scoreError, ""); // Clear previous errors

                try {
                    // *** API CALL: Get Scores ***
                    // Adjust URL/method based on your API design
                    const url = `${API.scores}?gameKey=${encodeURIComponent(currentGameKey)}`; // Example for GET
                    const data = await apiCall(url, { method: 'GET' }); // Adjust method if needed


                    if (!data || typeof data.scores !== 'object') {
                         throw new Error("Invalid score data format received from server.");
                    }

                    // --- Update Scoreboard UI ---
                    scoreList.innerHTML = ''; // Clear existing scores

                    // Sort scores: Convert to array [username, score], sort, then map back
                    const sortedScores = Object.entries(data.scores)
                                             .sort(([, scoreA], [, scoreB]) => scoreB - scoreA); // Sort descending by score

                    if (sortedScores.length === 0) {
                        scoreList.innerHTML = '<li class="text-gray-500 italic">No scores yet.</li>';
                    } else {
                        sortedScores.forEach(([player, score]) => {
                            const li = document.createElement('li');
                            li.className = 'flex justify-between items-center py-1 border-b border-gray-200 last:border-b-0';
                            // Highlight current user's score?
                            const isCurrentUser = player === currentUsername;
                            li.innerHTML = `
                                <span class="font-medium ${isCurrentUser ? 'text-blue-600' : 'text-gray-700'}">${player}</span>
                                <span class="font-bold ${isCurrentUser ? 'text-blue-700' : 'text-gray-800'}">${score}</span>
                            `;
                            scoreList.appendChild(li);
                        });
                    }

                } catch (error) {
                    console.error("Score fetch error:", error);
                    displayError(scoreError, `Could not update scores: ${error.message}`);
                    // Consider stopping polling if errors persist?
                }
            }

            // --- Polling Control ---

            /** Starts polling for score updates periodically. */
            function startScorePolling() {
                stopScorePolling(); // Clear any existing interval first
                scoreUpdateInterval = setInterval(fetchScores, SCORE_POLL_INTERVAL_MS);
                console.log(`Score polling started (interval: ${SCORE_POLL_INTERVAL_MS}ms)`);
            }

            /** Stops polling for score updates. */
            function stopScorePolling() {
                if (scoreUpdateInterval) {
                    clearInterval(scoreUpdateInterval);
                    scoreUpdateInterval = null;
                    console.log("Score polling stopped.");
                }
            }

             /** Starts polling for game state updates periodically. */
            function startGameStatePolling() {
                stopGameStatePolling(); // Clear any existing interval first
                // Fetch immediately first time
                fetchGameState();
                gameStateCheckInterval = setInterval(fetchGameState, GAME_STATE_POLL_INTERVAL_MS);
                console.log(`Game state polling started (interval: ${GAME_STATE_POLL_INTERVAL_MS}ms)`);
            }

            /** Stops polling for game state updates. */
            function stopGameStatePolling() {
                if (gameStateCheckInterval) {
                    clearInterval(gameStateCheckInterval);
                    gameStateCheckInterval = null;
                    console.log("Game state polling stopped.");
                }
            }

            // --- Event Listeners ---
            loginButton.addEventListener('click', login);
            submitGuessButton.addEventListener('click', submitGuess);

            // Allow submitting with Enter key in input fields
            guessInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !submitGuessButton.disabled) {
                    event.preventDefault(); // Prevent default form submission if it were in a form
                    submitGuess();
                }
            });

            usernameInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                     event.preventDefault();
                     gameKeyInput.focus(); // Move focus to next field
                }
            });

            gameKeyInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !loginButton.disabled) {
                    event.preventDefault();
                    login();
                }
            });

            // Clean up intervals when the page is unloaded (optional but good practice)
            window.addEventListener('beforeunload', () => {
                stopScorePolling();
                stopGameStatePolling();
            });

        }); // End DOMContentLoaded
    </script>
</body>
</html>
