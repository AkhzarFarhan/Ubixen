<!-- An HTML page that fetches data from Google CLoud Function and plots a graph using plotly -->
<DOCTYPE html>
    <html>
    <head>
        <title>Finance</title>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    </head>
    <body onload="getData()">
        <div id="myDiv"><!-- Plotly chart will be drawn inside this DIV --></div>
        <div class="loading-spinner" id="loading-spinner"></div>
        <script>
            // Fetch data from Google Cloud Function
            function getData() {
                var url = 'https://us-central1-github-284317.cloudfunctions.net/finance';
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.send();
                xhr.onreadystatechange = processRequest;
                function processRequest(e) {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var response = JSON.parse(xhr.responseText);
                        console.log('response: ', response);
                        var keys = Object.keys(response);
                        var key_length = response['size'];
                        var data = [];
                        var pdata = [];
                        var mpdata = [];
                        var e = document.getElementById('myDiv');
                        // Plot third value also in same graph
                        for (var i = 0; i < key_length; i++) {
                            var key = keys[i];
                            var value = response[key];
                            data.push({
                                x: value[0],
                                y: value[1],
                                name: key,
                                type: 'scatter'
                            });
                            pdata.push({
                                x: value[0],
                                y: value[2],
                                name: key,
                                type: 'scatter'
                            });
                            mpdata.push({
                                x: value[3][0],
                                y: value[3][1],
                                name: key,
                                type: 'scatter'
                            });
                        }
                        document.getElementById('loading-spinner').style.display = 'none';
                        for (var i = 0; i < data.length; i++) {
                            var trace = data[i];
                            var ptrace = pdata[i];
                            var mptrace = mpdata[i];
                            var layout = {
                                title: keys[i],
                                xaxis: {
                                    title: 'Date',
                                    showgrid: false,
                                    zeroline: false
                                },
                                yaxis: {
                                    title: 'Price',
                                    showline: false
                                }
                            };
                            var d = document.createElement('div');
                            var p = document.createElement('div');
                            var m = document.createElement('div');
                            d.setAttribute('id', keys[i]);
                            p.setAttribute('id', keys[i] + 'p');
                            m.setAttribute('id', keys[i] + 'mp');
                            e.appendChild(d);
                            e.appendChild(p);
                            e.appendChild(m);
                            Plotly.newPlot(keys[i], [trace], layout);
                            Plotly.newPlot(keys[i] + 'p', [ptrace], layout);
                            Plotly.newPlot(keys[i] + 'mp', [mptrace], layout);
                        }
                    }
                }
            }
        </script>
        <style>
            .loading-spinner {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 100px;
                height: 100px;
                border: 8px solid #f3f3f3;
                border-top: 8px solid #3498db;
                border-radius: 50%;
                animation: spin 1s infinite linear;
            }
    
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
    
        </style>
    </body>
    </html>